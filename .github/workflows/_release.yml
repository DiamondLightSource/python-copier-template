on:
  workflow_call:

jobs:
  artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Dependencies license compliance checker
        id: license_check_report
        uses: pilosus/action-pip-license-checker@cc7a461bfa27b44ad187b8578c881ef5138c13fd
        with:
          external: "licenses.csv"
          external-format: "csv"
          external-options: "{:skip-header false :package-column-index 0 :license-column-index 2}"
          report-format: "json-pretty"
          formatter: "%-65s %-65s %-20s %-40s"
          totals: true
          headers: true
          fail: "StrongCopyleft,NetworkCopyleft,Other,Error"
          verbose: 1
      - name: Save report
        if: ${{ always() }}
        run: echo "${{ steps.license_check_report.outputs.report }}" > license-report.json
      - name: Upload artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: license-report
          path: license-report.json

      - name: Zip up docs
        run: |
          set -vxeuo pipefail
          if [ -d html ]; then
            mv html $GITHUB_REF_NAME
            zip -r docs.zip $GITHUB_REF_NAME
            rm -rf $GITHUB_REF_NAME
          fi

      - name: Create GitHub Release
        # We pin to the SHA, not the tag, for security reasons.
        # https://docs.github.com/en/actions/learn-github-actions/security-hardening-for-github-actions#using-third-party-actions
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          prerelease: ${{ contains(github.ref_name, 'a') || contains(github.ref_name, 'b') || contains(github.ref_name, 'rc') }}
          files: "*"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
